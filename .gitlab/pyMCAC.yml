.python_init: &python_init
  - pwd
  - ls -l
  - python3 -V               # Print out python version for debugging
  - source venv/bin/activate

build-python:
  stage: Build pyMCAC
  script:
    - pwd
    - ls -l
    - python3 -V               # Print out python version for debugging
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
    - pip install .
  only:
    changes:
      - .gitlab/pyMCAC.yml
      - ext_bin/**/*
      - pymcac/**/*
  artifacts:
    paths:
      - venv
  needs: ["build-release"]
  dependencies:
    - build-release

mypy:
  stage: Static Analysis
  script:
    - *python_init
    - pip install mypy
    - mypy
  only:
    changes:
      - .gitlab/pyMCAC.yml
      - venv/**/*
      - pymcac/**/*
  needs: ["build-python"]
  dependencies:
    - build-python

flake8:
  stage: Static Analysis
  script:
    - *python_init
    - pip install flake8
    - flake8
  only:
    changes:
      - .gitlab/pyMCAC.yml
      - venv/**/*
      - pymcac/**/*
  needs: ["build-python"]
  dependencies:
    - build-python

pylint:
  stage: Static Analysis
  #allow_failure: true
  script:
    - *python_init
    - pip install pylint
    - pylint -d C0301 bild/*.py
  needs: ["build-python"]
  dependencies:
    - build-python

isort:
  stage: Static Analysis
  #allow_failure: true
  script:
    - *python_init
    - pip install isort
    - isort .
  only:
    changes:
      - .gitlab/pyMCAC.yml
      - venv/**/*
      - pymcac/**/*
  needs: ["build-python"]
  dependencies:
    - build-python

black:
  stage: Static Analysis
  #allow_failure: true
  script:
    - *python_init
    - pip install black
    - black .
  only:
    changes:
      - .gitlab/pyMCAC.yml
      - venv/**/*
      - pymcac/**/*
  needs: ["build-python"]
  dependencies:
    - build-python

pymcac_tests:
  stage: Test
  script:
    - *python_init
    - pip install pytest
    - export PYTHONPATH="$PYTHONPATH:."
    - python -c "import sys;print(sys.path)"
    - pytest
  only:
    changes:
      - .gitlab/pyMCAC.yml
      - venv/**/*
      - pymcac/**/*
  needs: ["build-python"]
  dependencies:
    - build-python
